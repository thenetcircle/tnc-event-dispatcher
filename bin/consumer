#!/usr/bin/env php
<?php

if (version_compare('5.6.0', PHP_VERSION, '>')) {
    fwrite(
        STDERR,
        'The runner requires PHP 5.6; using the latest version of PHP is highly recommended.' . PHP_EOL
    );

    die(1);
}

if (!ini_get('date.timezone')) {
    ini_set('date.timezone', 'UTC');
}

foreach (array(__DIR__ . '/../../autoload.php', __DIR__ . '/../vendor/autoload.php', __DIR__ . '/vendor/autoload.php') as $file) {
    if (file_exists($file)) {
        define('COMPOSER_AUTOLOAD_FILE', $file);

        break;
    }
}

unset($file);

if (!defined('COMPOSER_AUTOLOAD_FILE')) {
    fwrite(STDERR,
           'You need to set up the project dependencies using the following commands:' . PHP_EOL .
           'wget http://getcomposer.org/composer.phar' . PHP_EOL .
           'php composer.phar install' . PHP_EOL
    );

    die(1);
}

require COMPOSER_AUTOLOAD_FILE;

$driver = new \Tnc\Service\EventDispatcher\Driver\KafkaDriver(
    '10.20.2.103:19092,10.20.2.103:29092,10.20.2.103:39092',
    [],
    false
);

$serializer = new \Tnc\Service\EventDispatcher\Serializer\JsonSerializer();

$pipeline = new \Tnc\Service\EventDispatcher\Pipeline\PersistentPipeline($driver, $serializer);

$i = 0;
while(true)
{
    $topic = '^' . \Tnc\Service\EventDispatcher\Event\AbstractEvent::getChannelPrefix() . '*';
    echo PHP_EOL;
    echo '-------------------- ' . $i . PHP_EOL;
    echo 'will listen topic: ' . $topic . PHP_EOL;
    try {
        $eventWrapper = $pipeline->pop($topic);
        if($eventWrapper){
            $i++;
        }
    }
    catch (Exception $e) {
        echo get_class($e) . ' - ' . $e->getMessage() . PHP_EOL;
    }
    // sleep(3);
}
